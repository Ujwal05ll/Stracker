<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Attendance & Performance Tracker</title>
  <style>
    :root {
      --color-white: #fff;
      --color-gray-200: #f4f4f4;
      --color-gray-300: #ecf0f1;
      --color-charcoal: #2c3e50;
      --color-blue: #3498db;
      --color-success: #27ae60;
      --color-warning: #f39c12;
      --color-danger: #e74c3c;
      --color-info: #3498db;
      --color-border: #bdc3c7;
    }

    body {
      background: var(--color-gray-200);
      color: var(--color-charcoal);
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      margin: 0;
    }

    .centered {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
    }

    .login-card {
      background: var(--color-white);
      padding: 2rem 2rem;
      border-radius: 16px;
      box-shadow: 0 2px 8px 0 rgba(44,62,80,0.09);
      width: 100%;
      max-width: 320px;
      margin-bottom: 2rem;
    }

    .login-card h2 {
      margin-bottom: 1.5rem;
      color: var(--color-charcoal);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: .5rem;
      color: var(--color-charcoal);
    }

    input[type="text"], input[type="password"] {
      width: 100%;
      padding: .5rem .75rem;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 16px;
      background: var(--color-gray-300);
      color: var(--color-charcoal);
    }

    .login-btn, .toggle-btn, .btn {
      padding: .7rem 1.2rem;
      background: var(--color-blue);
      color: var(--color-white);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: .75rem;
      transition: background .2s;
    }

    .toggle-btn {
      background: var(--color-gray-300);
      color: var(--color-charcoal);
      margin-right: .5rem;
      margin-top: 0;
    }

    .login-btn:hover, .btn:hover {
      background: #217dbb;
    }

    .sidebar {
      background: var(--color-gray-300);
      min-width: 200px;
      max-width: 220px;
      height: 100vh;
      padding-top: 2rem;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      z-index: 100;
      box-shadow: 0 0 12px rgba(44,62,80,0.05);
    }

    .sidebar h3 {
      margin-left: 1rem;
      margin-bottom: 2rem;
      font-size: 1.25rem;
      color: var(--color-blue);
      font-weight: 700;
    }

    .nav-link {
      display: block;
      padding: .7rem 1.5rem;
      color: var(--color-charcoal);
      text-decoration: none;
      border-radius: 6px;
      margin-bottom: .25rem;
      font-size: 1rem;
      transition: background .2s;
    }

    .nav-link.active, .nav-link:hover {
      background: var(--color-blue);
      color: var(--color-white);
    }

    .topbar {
      width: calc(100% - 220px);
      margin-left: 220px;
      background: var(--color-white);
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      border-bottom: 1px solid var(--color-border);
      position: fixed;
      top: 0;
      left: 0;
      z-index: 50;
    }

    .topbar h2 {
      color: var(--color-blue);
      font-size: 1.22rem;
      font-weight: 600;
      margin: 0;
    }

    .logout-btn {
      background: var(--color-danger);
      color: var(--color-white);
      border: none;
      border-radius: 8px;
      padding: .5rem 1rem;
      cursor: pointer;
      font-size: 1rem;
      transition: background .2s;
    }
    .logout-btn:hover {
      background: #ab2330;
    }

    .main {
      margin-left: 220px;
      margin-top: 70px;
      padding: 2rem 3vw;
      max-width: 1200px;
    }

    .dashboard-cards {
      display: flex;
      gap: 1.2rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--color-white);
      border-radius: 14px;
      box-shadow: 0 2px 6px 0 rgba(44,62,80,0.08);
      padding: 1.2rem 1.5rem;
      min-width: 170px;
      flex: 1 1 180px;
      text-align: left;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .card h4 {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: .5rem;
      color: var(--color-charcoal);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-blue);
      margin-bottom: .5rem;
    }

    .progress-bar-bg {
      background: var(--color-gray-300);
      width: 100%;
      height: 16px;
      border-radius: 10px;
      overflow: hidden;
      margin: .5rem 0;
    }
    .progress-bar {
      height: 100%;
      border-radius: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--color-white);
      font-size: 1rem;
      margin-bottom: 1.8rem;
    }
    th, td {
      padding: .7rem .7vw;
      text-align: left;
      border-bottom: 1px solid var(--color-gray-200);
    }
    th {
      background: var(--color-gray-300);
      color: var(--color-charcoal);
      font-weight: 600;
    }
    tr:nth-child(even) {
      background: var(--color-gray-200);
    }

    .badge {
      display: inline-block;
      padding: .4em .9em;
      border-radius: 18px;
      font-size: .9em;
      color: var(--color-white);
      font-weight: 600;
      margin-right: .2em;
    }
    .badge.present { background: var(--color-success);}
    .badge.absent { background: var(--color-danger);}
    .badge.late { background: var(--color-warning);}
    .badge.excused { background: var(--color-info);}

    .success, .error {
      display: inline-block;
      margin-bottom: 1rem;
      padding: .7rem 1rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
    }
    .success {
      color: var(--color-success);
      background: #eafaf1;
      border: 1px solid var(--color-success);
    }
    .error {
      color: var(--color-danger);
      background: #fceaea;
      border: 1px solid var(--color-danger);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 1.2rem;
    }
    .calendar-cell {
      height: 32px;
      border-radius: 6px;
      font-size: .95em;
      text-align: center;
      line-height: 32px;
      background: var(--color-gray-300);
      margin-bottom: 3px;
      color: #2c3e50;
      font-weight: 500;
    }
    .calendar-cell.present { background: var(--color-success); color: #fff;}
    .calendar-cell.absent { background: var(--color-danger); color: #fff;}
    .calendar-cell.late { background: var(--color-warning); color: #fff;}
    .calendar-cell.excused { background: var(--color-info); color: #fff;}

    @media (max-width: 850px) {
      .sidebar { display: none; }
      .main, .topbar {
        margin-left: 0;
        width: 100%;
      }
      .main {padding: 1rem;}
      .dashboard-cards {flex-direction: column; gap: 1rem;}
    }

    @media (max-width: 600px) {
      .login-card { padding: 1rem; }
      .dashboard-cards { flex-direction: column; }
      .main {padding: 0.3rem;}
      .card {padding: 1rem;}
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    // ----------------------------------------------
    // SAMPLE DATA
    // ----------------------------------------------
    const students = [
      { id: 1, name: "Rahul Sharma", roll: "CS2024001", class: "CS A", email: "rahul@school.com" },
      { id: 2, name: "Priya Patel", roll: "CS2024002", class: "CS A", email: "priya@school.com" },
      { id: 3, name: "Amit Kumar", roll: "CS2024003", class: "CS A", email: "amit@school.com" },
      { id: 4, name: "Sneha Singh", roll: "CS2024004", class: "CS A", email: "sneha@school.com" },
      { id: 5, name: "Rohan Verma", roll: "CS2024005", class: "CS A", email: "rohan@school.com" },
      { id: 6, name: "Anjali Gupta", roll: "CS2024006", class: "CS A", email: "anjali@school.com" },
      { id: 7, name: "Vikram Reddy", roll: "CS2024007", class: "CS A", email: "vikram@school.com" },
      { id: 8, name: "Pooja Nair", roll: "CS2024008", class: "CS A", email: "pooja@school.com" },
      { id: 9, name: "Karthik Iyer", roll: "CS2024009", class: "CS A", email: "karthik@school.com" },
      { id: 10, name: "Divya Menon", roll: "CS2024010", class: "CS A", email: "divya@school.com" },
      { id: 11, name: "Arjun Desai", roll: "CS2024011", class: "CS A", email: "arjun@school.com" },
      { id: 12, name: "Meera Joshi", roll: "CS2024012", class: "CS A", email: "meera@school.com" },
      { id: 13, name: "Sanjay Pillai", roll: "CS2024013", class: "CS A", email: "sanjay@school.com" },
      { id: 14, name: "Kavya Rao", roll: "CS2024014", class: "CS A", email: "kavya@school.com" },
      { id: 15, name: "Nikhil Shetty", roll: "CS2024015", class: "CS A", email: "nikhil@school.com" },
    ];

    const assessmentTypes = ["Quiz", "Assignment", "Midterm", "Final Exam", "Project", "Practical"];
    const subjects = ["Mathematics", "Physics", "Chemistry", "Computer Science", "English", "Data Structures"];
    const attendanceStatus = {
      present: { label: "Present", class: "present" },
      absent: { label: "Absent", class: "absent" },
      late: { label: "Late", class: "late" },
      excused: { label: "Excused", class: "excused" }
    };

    // Create attendance records for past 30 days for each student
    function getPastDays(days = 30) {
      let arr = [];
      let today = new Date();
      for (let i = days-1; i >= 0; i--) {
        let d = new Date(today);
        d.setDate(d.getDate() - i);
        arr.push(d.toISOString().substring(0,10));
      }
      return arr;
    }

    let attendanceRecords = {};
    getPastDays().forEach(date => {
      attendanceRecords[date] = students.map(s => {
        let statusRand = Math.random();
        let status = statusRand > 0.96 ? 'absent'
                     : statusRand > 0.92 ? 'late'
                     : statusRand > 0.87 ? 'excused'
                     : 'present';
        return { studentId: s.id, status };
      });
    });

    // Sample assessment data
    let performanceRecords = [];
    students.forEach(s => {
      for (let i = 0; i < assessmentTypes.length; i++) {
        let subject = subjects[Math.floor(Math.random() * subjects.length)];
        let score = Math.floor(Math.random() * 41) + 60; // 60-100
        let max = 100;
        performanceRecords.push({
          studentId: s.id,
          type: assessmentTypes[i],
          subject,
          score,
          max,
          comments: score < 70 ? "Needs improvement" : score > 90 ? "Excellent!" : "Good job",
          date: getPastDays()[Math.floor(Math.random()*30)]
        });
      }
    });

    // ----------------------------------------------
    // APP JS
    // ----------------------------------------------
    const facultyUser = { username: "teacher@school.com", password: "teacher123" };
    const studentUser = { username: "student@school.com", password: "student123", studentId: 2 }; // use student 2 as default

    let currentUser = null; // {role: 'faculty'|'student', ...}
    let currentPage = "";

    const appEl = document.getElementById("app");

    function renderLogin(role="faculty") {
      appEl.innerHTML = `
        <div class="centered">
          <div class="login-card">
            <h2>Login as ${role === "faculty" ? "Faculty" : "Student"}</h2>
            <div class="form-group">
              <label for="username">Username</label>
              <input type="text" id="login-username" autocomplete="username"/>
            </div>
            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="login-password" autocomplete="current-password"/>
            </div>
            <button class="login-btn" id="login-btn">Login</button>
            <div style="margin-top:.7rem;font-size:.96em;">
              <button class="toggle-btn" id="toggle-role-btn">${role==="faculty"?"Student Login":"Faculty Login"}</button>
            </div>
            <div id="login-message"></div>
          </div>
        </div>
      `
      document.getElementById("login-btn").onclick = () => doLogin(role);
      document.getElementById("toggle-role-btn").onclick = () => renderLogin(role==="faculty"?"student":"faculty");
    }

    function doLogin(role) {
      let username = document.getElementById("login-username").value.trim();
      let password = document.getElementById("login-password").value.trim();
      let ok = false;
      if (role === "faculty") {
        if (username === facultyUser.username && password === facultyUser.password) {
          ok = true;
          currentUser = { role: "faculty", username };
        }
      } else {
        if (username === studentUser.username && password === studentUser.password) {
          ok = true;
          currentUser = { role: "student", username, studentId: studentUser.studentId };
        }
      }
      const msgEl = document.getElementById("login-message");
      if (ok) {
        renderApp();
      } else {
        // show error
        msgEl.innerHTML = `<span class="error">Invalid username or password!</span>`;
      }
    }

    // ----------------------------------
    // MAIN APP RENDER
    // ----------------------------------
    function renderApp() {
      // sidebar, topbar
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
      let sidebarHtml = `
        <nav class="sidebar">
          <h3>Student Tracker</h3>
          ${
            currentUser.role === "faculty"
            ? `
            <a class="nav-link" id="nav-fdashboard">Dashboard</a>
            <a class="nav-link" id="nav-markattendance">Mark Attendance</a>
            <a class="nav-link" id="nav-enterperformance">Enter Performance</a>
            <a class="nav-link" id="nav-viewreports">View Reports</a>
            <a class="nav-link" id="nav-studentmanage">Students</a>
            `
            : `
            <a class="nav-link" id="nav-sdashboard">Dashboard</a>
            <a class="nav-link" id="nav-sattendance">My Attendance</a>
            <a class="nav-link" id="nav-sperformance">My Performance</a>
            <a class="nav-link" id="nav-sprofile">Profile</a>
            `
          }
        </nav>
      `;
      let topbarHtml = `
        <div class="topbar">
          <h2>${currentUser.role === "faculty" ? "Faculty Portal" : "Student Portal"}</h2>
          <button class="logout-btn" id="logout-btn">Logout</button>
        </div>
      `;
      appEl.innerHTML = sidebarHtml + topbarHtml + `<main class="main" id="main-content"></main>`;

      document.getElementById("logout-btn").onclick = () => {
        currentUser = null;
        currentPage = "";
        renderLogin();
      };

      setupNavLinks();
      renderPage(currentUser.role === "faculty" ? "fdashboard" : "sdashboard");
    }

    function setupNavLinks() {
      if(currentUser.role === "faculty"){
        document.getElementById("nav-fdashboard").onclick = () => renderPage("fdashboard");
        document.getElementById("nav-markattendance").onclick = () => renderPage("markattendance");
        document.getElementById("nav-enterperformance").onclick = () => renderPage("enterperformance");
        document.getElementById("nav-viewreports").onclick = () => renderPage("viewreports");
        document.getElementById("nav-studentmanage").onclick = () => renderPage("studentmanage");
      }else{
        document.getElementById("nav-sdashboard").onclick = () => renderPage("sdashboard");
        document.getElementById("nav-sattendance").onclick = () => renderPage("sattendance");
        document.getElementById("nav-sperformance").onclick = () => renderPage("sperformance");
        document.getElementById("nav-sprofile").onclick = () => renderPage("sprofile");
      }
      // highlight nav links
      let links = document.querySelectorAll('.nav-link');
      links.forEach(l => l.onclick = (e) => {
        links.forEach(l2=>l2.classList.remove('active'));
        l.classList.add('active');
      });
    }

    function renderPage(page) {
      currentPage = page;
      let mainEl = document.getElementById("main-content");
      if(currentUser.role === "faculty"){
        if(page === "fdashboard") renderFacultyDashboard(mainEl);
        else if(page === "markattendance") renderMarkAttendance(mainEl);
        else if(page === "enterperformance") renderEnterPerformance(mainEl);
        else if(page === "viewreports") renderViewReports(mainEl);
        else if(page === "studentmanage") renderStudentManagement(mainEl);
        else renderFacultyDashboard(mainEl);
      }else{
        if(page === "sdashboard") renderStudentDashboard(mainEl);
        else if(page === "sattendance") renderStudentAttendance(mainEl);
        else if(page === "sperformance") renderStudentPerformance(mainEl);
        else if(page === "sprofile") renderStudentProfile(mainEl);
        else renderStudentDashboard(mainEl);
      }
    }

    // ---------------- Faculty Portal Pages -----------------
    function renderFacultyDashboard(mainEl){
      // Attendance summary (today), stats, performance, students
      let today = new Date().toISOString().substring(0,10);
      let recs = attendanceRecords[today] || [];
      let present = recs.filter(r=>r.status==='present').length;
      let absent = recs.filter(r=>r.status==='absent').length;
      let late = recs.filter(r=>r.status==='late').length;
      let excused = recs.filter(r=>r.status==='excused').length;
      let avgAttendance = avgAttendancePercent();
      let avgPerf = avgPerformance();
      mainEl.innerHTML = `
        <h2>Dashboard</h2>
        <div class="dashboard-cards">
          <div class="card">
            <h4>Total Students</h4>
            <span class="stat-value">${students.length}</span>
          </div>
          <div class="card">
            <h4>Today's Attendance</h4>
            <span class="badge present">${present} Present</span>
            <span class="badge absent">${absent} Absent</span>
            <span class="badge late">${late} Late</span>
            <span class="badge excused">${excused} Excused</span>
          </div>
          <div class="card">
            <h4>Average Attendance</h4>
            <span class="stat-value">${avgAttendance.toFixed(1)}%</span>
            <div class="progress-bar-bg">
              <div class="progress-bar" style="width:${avgAttendance}%;background:var(--color-success)"></div>
            </div>
          </div>
          <div class="card">
            <h4>Average Performance</h4>
            <span class="stat-value">${avgPerf.toFixed(1)}%</span>
            <div class="progress-bar-bg">
              <div class="progress-bar" style="width:${avgPerf}%;background:var(--color-blue)"></div>
            </div>
          </div>
        </div>
      `;
    }
    function avgAttendancePercent(){
      // Calculate average percent of PRESENT days for all students in attendanceRecords
      let studentPresentDays = students.map(s=>{
        let presentDays = Object.values(attendanceRecords).filter(dayArr=>{
          let rec = dayArr.find(r=>r.studentId===s.id);
          return rec && rec.status==='present';
        }).length;
        return (presentDays/getPastDays().length)*100;
      });
      return studentPresentDays.reduce((a,b)=>a+b,0)/studentPresentDays.length;
    }
    function avgPerformance(){
      // avg percentage score
      let scores = performanceRecords.map(r=>100*r.score/r.max);
      return scores.length?scores.reduce((a,b)=>a+b,0)/scores.length:0;
    }

    function renderMarkAttendance(mainEl){
      // Faculty marks attendance for today (or choose another date)
      let today = new Date().toISOString().substring(0,10);
      let date = today;
      let classSection = "CS A";
      let recs = attendanceRecords[date] || students.map(s=>({studentId:s.id,status:'present'}));
      mainEl.innerHTML = `
        <h2>Mark Attendance</h2>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="attendance-date" value="${date}" />
        </div>
        <div class="form-group">
          <label>Class/Section</label>
          <select id="class-section-select"><option>CS A</option></select>
        </div>
        <table>
          <thead>
            <tr>
              <th>Name</th><th>Roll No.</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${students.map(s=>{
              let found = recs.find(r=>r.studentId===s.id);
              let stat = found?.status || 'present';
              return `
                <tr>
                  <td>${s.name}</td>
                  <td>${s.roll}</td>
                  <td>
                    <select data-id="${s.id}" class="att-status-select">
                      ${Object.keys(attendanceStatus).map(k=>{
                        return `<option value="${k}" ${stat===k?"selected":""}>${attendanceStatus[k].label}</option>`;
                      }).join('')}
                    </select>
                  </td>
                </tr>
              `
            }).join('')}
          </tbody>
        </table>
        <button class="btn" id="attendance-submit-btn">Submit</button>
        <div id="attendance-summary"></div>
      `;

      document.getElementById("attendance-date").onchange = (e)=>{
        renderMarkAttendance(mainEl);
      };
      document.getElementById("attendance-submit-btn").onclick = ()=>{
        // Save all status
        let selects = mainEl.querySelectorAll(".att-status-select");
        recs = [];
        selects.forEach(sel=>{
          let sid = +sel.getAttribute("data-id");
          let status = sel.value;
          recs.push({studentId:sid, status});
        });
        attendanceRecords[date] = recs;
        // Show summary
        let summary = {present:0, absent:0, late:0, excused:0};
        recs.forEach(r=>summary[r.status]++);
        document.getElementById("attendance-summary").innerHTML = `<span class="success">Attendance saved: 
          ${summary.present} Present, ${summary.absent} Absent, ${summary.late} Late, ${summary.excused} Excused</span>`;
      };
    }

    function renderEnterPerformance(mainEl){
      mainEl.innerHTML = `
        <h2>Enter Performance</h2>
        <form id="performance-form">
          <div class="form-group">
            <label>Student</label>
            <select id="perf-student">
              ${students.map(s=>`<option value="${s.id}">${s.name} (${s.roll})</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>Assessment Type</label>
            <select id="perf-type">
              ${assessmentTypes.map(t=>`<option>${t}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>Subject</label>
            <select id="perf-subject">
              ${subjects.map(s=>`<option>${s}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>Score</label>
            <input type="number" min="0" max="100" id="perf-score" />
          </div>
          <div class="form-group">
            <label>Max Marks</label>
            <input type="number" min="1" max="100" id="perf-max" value="100"/>
          </div>
          <div class="form-group">
            <label>Comments/Feedback</label>
            <input type="text" id="perf-comments" />
          </div>
          <button class="btn" type="submit">Add Record</button>
        </form>
        <div id="perf-form-msg"></div>
      `;
      document.getElementById("performance-form").onsubmit = (e)=>{
        e.preventDefault();
        let studentId = +document.getElementById("perf-student").value;
        let type = document.getElementById("perf-type").value;
        let subject = document.getElementById("perf-subject").value;
        let score = +document.getElementById("perf-score").value;
        let max = +document.getElementById("perf-max").value;
        let comments = document.getElementById("perf-comments").value.trim();
        if(!score || !max || !type || !subject || !studentId){
          document.getElementById("perf-form-msg").innerHTML = `<span class="error">Please fill all fields correctly</span>`;
          return;
        }
        performanceRecords.push({
          studentId,type,subject,score,max,comments,
          date:new Date().toISOString().substring(0,10)
        });
        document.getElementById("perf-form-msg").innerHTML = `<span class="success">Record added!</span>`;
        document.getElementById("performance-form").reset();
      };
    }

    function renderViewReports(mainEl){
      mainEl.innerHTML = `
        <h2>View Reports</h2>
        <div style="margin-bottom:1.2rem">
          <label>Report Type: </label>
          <select id="report-type">
            <option value="attendance">Attendance Report</option>
            <option value="performance">Performance Report</option>
          </select>
        </div>
        <div id="report-content"></div>
      `;
      function attendanceReport(){
        let tableHtml = `
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Roll</th>
                <th>Attendance %</th>
              </tr>
            </thead>
            <tbody>
              ${students.map(s=>{
                let presentDays = Object.values(attendanceRecords)
                  .filter(dayArr=>{
                    let rec = dayArr.find(r=>r.studentId===s.id);
                    return rec && rec.status==='present';
                  }).length;
                let percent = (presentDays/getPastDays().length)*100;
                let badgeClass = percent > 90 ? "success" : percent > 75 ? "warning" : "danger";
                return `<tr>
                  <td>${s.name}</td>
                  <td>${s.roll}</td>
                  <td><span class="badge ${badgeClass}">${percent.toFixed(1)}%</span></td>
                </tr>`;
              }).join("")}
            </tbody>
          </table>`;
        return tableHtml;
      }
      function performanceReport(){
        let tableHtml = `
          <table>
            <thead>
              <tr>
                <th>Name</th><th>Roll</th>
                <th>Average Score (%)</th>
              </tr>
            </thead>
            <tbody>
              ${students.map(s=>{
                let recs = performanceRecords.filter(r=>r.studentId === s.id);
                let avg = recs.length ? recs.reduce((a,b)=>a+100*b.score/b.max,0)/recs.length : 0;
                let badgeClass = avg>85?"success":avg>70?"warning":"danger";
                return `<tr>
                  <td>${s.name}</td>
                  <td>${s.roll}</td>
                  <td><span class="badge ${badgeClass}">${avg.toFixed(1)}%</span></td>
                </tr>`;
              }).join("")}
            </tbody>
          </table>`;
        return tableHtml;
      }

      document.getElementById("report-type").onchange = (e)=>{
        renderTable(e.target.value);
      };

      function renderTable(type){
        document.getElementById("report-content").innerHTML = type==="performance" ? performanceReport() : attendanceReport();
      }
      renderTable("attendance");
    }

    function renderStudentManagement(mainEl){
      mainEl.innerHTML = `
        <h2>Student Management</h2>
        <table>
          <thead>
            <tr><th>Name</th><th>Roll</th><th>Class</th><th>Email</th><th>Actions</th></tr>
          </thead>
          <tbody>
            ${students.map(s=>`
              <tr>
                <td>${s.name}</td>
                <td>${s.roll}</td>
                <td>${s.class}</td>
                <td>${s.email}</td>
                <td>
                  <button class="btn btn-sm" onclick="deleteStudent(${s.id})">Delete</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
        <div style="margin-bottom:.8rem;font-weight:600;font-size:1.12em;">Add New Student:</div>
        <form id="add-student-form" style="display:flex;gap:.9rem;flex-wrap:wrap;">
          <input type="text" id="new-name" placeholder="Name"/>
          <input type="text" id="new-roll" placeholder="Roll No."/>
          <input type="text" id="new-class" placeholder="Class"/>
          <input type="text" id="new-email" placeholder="Email"/>
          <button class="btn" type="submit">Add</button>
        </form>
        <div id="add-student-msg"></div>
      `;
      document.getElementById("add-student-form").onsubmit=(e)=>{
        e.preventDefault();
        let name = document.getElementById("new-name").value.trim();
        let roll = document.getElementById("new-roll").value.trim();
        let cls = document.getElementById("new-class").value.trim();
        let email = document.getElementById("new-email").value.trim();
        if(!name||!roll||!cls||!email){
          document.getElementById("add-student-msg").innerHTML = `<span class="error">Enter all fields</span>`;
          return;
        }
        students.push({ id: students.length+1, name, roll, class: cls, email });
        renderStudentManagement(mainEl);
        document.getElementById("add-student-msg").innerHTML = `<span class="success">Student added</span>`;
      };
      window.deleteStudent = (id) => {
        let idx = students.findIndex(s=>s.id===id);
        if(idx>-1){
          students.splice(idx,1);
          renderStudentManagement(mainEl);
        }
      };
    }

    // --------------- Student Portal Pages --------------------
    function renderStudentDashboard(mainEl){
      let s = students.find(st=>st.id===currentUser.studentId) || students[0];
      let percent = calcStudentAttendance(s.id);
      let perfStats = calcPerformanceStats(s.id);
      mainEl.innerHTML = `
        <h2>My Dashboard</h2>
        <div class="dashboard-cards">
          <div class="card">
            <h4>Attendance</h4>
            <span class="stat-value">${percent.toFixed(1)}%</span>
            <div class="progress-bar-bg">
              <div class="progress-bar" style="width:${percent}%;background:var(--color-success)"></div>
            </div>
          </div>
          <div class="card">
            <h4>Recent Grades</h4>
            ${perfStats.recent.map(r=>`
              <div>
                ${r.subject} (${r.type}): 
                <span class="badge ${r.score>85?'success':r.score>70?'warning':'danger'}"
                >${r.score}%</span>
              </div>
            `).join("")}
          </div>
          <div class="card">
            <h4>Upcoming Assignments</h4>
            <div style="font-size:1em;">
              <em>No new assignments</em>
            </div>
          </div>
          <div class="card">
            <h4>Performance Trend</h4>
            <div class="progress-bar-bg">
              <div class="progress-bar" style="width:${perfStats.avg}%;background:var(--color-blue)"></div>
            </div>
            <span>${perfStats.avg.toFixed(1)}%</span>
          </div>
        </div>
      `;
    }
    function calcStudentAttendance(studentId){
      let presentDays = Object.values(attendanceRecords)
        .filter(dayArr=>dayArr.find(r=>r.studentId===studentId && r.status==='present')).length;
      return 100 * presentDays / getPastDays().length;
    }
    function calcPerformanceStats(studentId){
      let recs = performanceRecords.filter(r=>r.studentId===studentId);
      let recent = recs.slice(-4).map(r=>({type:r.type,subject:r.subject,score:Math.round(100*r.score/r.max)}));
      let avg = recs.length ? recs.reduce((a,b)=>a+100*b.score/b.max,0)/recs.length : 0;
      return {recent,avg};
    }

    function renderStudentAttendance(mainEl){
      let s = students.find(st=>st.id===currentUser.studentId) || students[0];
      let daysArr = getPastDays();
      let stats = {present:0,absent:0,late:0,excused:0};
      let gridCells = daysArr.map(date=>{
        let rec = attendanceRecords[date]?.find(r=>r.studentId===s.id);
        let status = rec?rec.status:'absent';
        stats[status]++;
        return `<span class="calendar-cell ${status}" title="${date}">${attendanceStatus[status].label[0]}</span>`;
      }).join("");
      let percent = calcStudentAttendance(s.id);
      mainEl.innerHTML = `
        <h2>My Attendance</h2>
        <div style="margin-bottom:.8rem;">
          <b>Attendance this month:</b> ${percent.toFixed(1)}%
        </div>
        <div class="calendar-grid">${gridCells}</div>
        <div style="margin-top:.9rem;font-size:1.07em;">
          <span class="badge present">Present: ${stats.present}</span>
          <span class="badge absent">Absent: ${stats.absent}</span>
          <span class="badge late">Late: ${stats.late}</span>
          <span class="badge excused">Excused: ${stats.excused}</span>
        </div>
      `;
    }

    function renderStudentPerformance(mainEl){
      let s = students.find(st=>st.id===currentUser.studentId) || students[0];
      let recs = performanceRecords.filter(r=>r.studentId===s.id);
      let avg = recs.length ? recs.reduce((a,b)=>a+100*b.score/b.max,0)/recs.length : 0;
      mainEl.innerHTML = `
        <h2>My Performance</h2>
        <div style="margin-bottom:1rem;">
          <b>Overall Average:</b> 
          <span class="badge ${avg>85?'success':avg>70?'warning':'danger'}">${avg.toFixed(1)}%</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Assessment Type</th>
              <th>Subject</th>
              <th>Date</th>
              <th>Score</th>
              <th>Max Marks</th>
              <th>Comments</th>
            </tr>
          </thead>
          <tbody>
            ${recs.map(r=>`
              <tr>
                <td>${r.type}</td>
                <td>${r.subject}</td>
                <td>${r.date}</td>
                <td><span class="badge ${r.score>85?'success':r.score>70?'warning':'danger'}">${r.score}</span></td>
                <td>${r.max}</td>
                <td>${r.comments}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderStudentProfile(mainEl){
      let s = students.find(st=>st.id===currentUser.studentId) || students[0];
      let percent = calcStudentAttendance(s.id);
      let perfStats = calcPerformanceStats(s.id);
      mainEl.innerHTML = `
        <h2>My Profile</h2>
        <table>
          <tr><td>Name</td><td>${s.name}</td></tr>
          <tr><td>Roll Number</td><td>${s.roll}</td></tr>
          <tr><td>Class</td><td>${s.class}</td></tr>
          <tr><td>Email</td><td>${s.email}</td></tr>
          <tr><td>Attendance % (Last 30 Days)</td><td><span class="badge ${percent>90?'success':percent>75?'warning':'danger'}">${percent.toFixed(1)}%</span></td></tr>
          <tr><td>Average Performance</td><td><span class="badge ${perfStats.avg>85?'success':perfStats.avg>70?'warning':'danger'}">${perfStats.avg.toFixed(1)}%</span></td></tr>
        </table>
      `;
    }

    // ---- init ----
    renderLogin();

  </script>
</body>
</html>
